name: Auto Upload Bot Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL from Telegram'
        required: true
      service:
        description: 'Destination service'
        required: true
      chat_id:
        description: 'Telegram Chat ID'
        required: true
      telegram_token:
        description: 'Bot Token from VPS'
        required: true
      pixeldrain_key:
        description: 'PixelDrain Key from VPS'
        required: true
      filename:
        description: 'Original filename'
        required: true
      file_type:
        description: 'File type (document/photo/video/link)'
        required: true
      message_id:
        description: 'Message ID for status updates'
        required: true

jobs:
  upload_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Download Status
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          CHAT_ID="${{ inputs.chat_id }}"
          MSG_ID="${{ inputs.message_id }}"
          
          MSG="â¬ *Upload Status*%0A%0A"
          MSG="${MSG}ğŸ“„ File: \`${{ inputs.filename }}\`%0A"
          MSG="${MSG}ğŸ“¦ Type: ${{ inputs.file_type }}%0A"
          MSG="${MSG}ğŸ¯ Destination: ${{ inputs.service }}%0A%0A"
          MSG="${MSG}ğŸ“Š *Current Status:* Downloading from source%0A"
          MSG="${MSG}â–°â–°â–°â–±â–±â–±â–±â–±â–±â–± 30%%"
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/editMessageText" \
            -d chat_id=$CHAT_ID \
            -d message_id=$MSG_ID \
            -d text="$MSG" \
            -d parse_mode="Markdown"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Sanitize & Download File
        id: download
        run: |
          RAW_URL="${{ inputs.file_url }}"
          FILENAME="${{ inputs.filename }}"
          
          echo "Raw URL: $RAW_URL"
          echo "Filename: $FILENAME"
          
          # Bersihkan URL ganda (jika ada)
          if [[ "$RAW_URL" == *"https://"*"https://"* ]]; then
             echo "Fixing Double URL..."
             CLEAN_URL=$(python3 -c "import sys; u=sys.argv[1]; print('https://' + u.split('https://')[-1])" "$RAW_URL")
          else
             CLEAN_URL="$RAW_URL"
          fi
          
          echo "Final URL: $CLEAN_URL"
          
          # Download file dengan nama asli
          OUTPUT_FILE="/tmp/$FILENAME"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -L --connect-timeout 30 --max-time 600 -o "$OUTPUT_FILE" "$CLEAN_URL"; then
              echo "âœ… Download berhasil!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âš ï¸ Download gagal, retry $RETRY_COUNT dari $MAX_RETRIES..."
              sleep 2
            fi
          done
          
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "âŒ Download gagal setelah $MAX_RETRIES percobaan"
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z "$OUTPUT_FILE" 2>/dev/null || stat -c%s "$OUTPUT_FILE")
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          echo "File size: $FILE_SIZE bytes ($FILE_SIZE_MB MB)"
          echo "file_path=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          echo "file_size_mb=$FILE_SIZE_MB" >> $GITHUB_OUTPUT

      - name: Send Upload Status
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          CHAT_ID="${{ inputs.chat_id }}"
          MSG_ID="${{ inputs.message_id }}"
          
          MSG="â« *Upload Status*%0A%0A"
          MSG="${MSG}ğŸ“„ File: \`${{ inputs.filename }}\`%0A"
          MSG="${MSG}ğŸ“¦ Type: ${{ inputs.file_type }}%0A"
          MSG="${MSG}ğŸ’¾ Size: ${{ steps.download.outputs.file_size_mb }} MB%0A%0A"
          MSG="${MSG}ğŸ“Š *Current Status:* Uploading to ${{ inputs.service }}%0A"
          MSG="${MSG}â–°â–°â–°â–°â–°â–°â–°â–±â–±â–± 70%%"
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/editMessageText" \
            -d chat_id=$CHAT_ID \
            -d message_id=$MSG_ID \
            -d text="$MSG" \
            -d parse_mode="Markdown"

      - name: Upload to PixelDrain
        id: upload_pixeldrain
        if: inputs.service == 'pixeldrain'
        run: |
          pip install requests > /dev/null 2>&1
          
          PK="${{ inputs.pixeldrain_key }}"
          PK=$(echo "$PK" | xargs)
          
          FILE="${{ steps.download.outputs.file_path }}"
          FILENAME="${{ inputs.filename }}"
          
          # Upload dengan nama file asli
          cat > /tmp/upload_script.py << 'EOFPYTHON'
          import requests
          import sys
          import os
          
          api_key = sys.argv[1]
          file_path = sys.argv[2]
          original_name = sys.argv[3]
          
          try:
              with open(file_path, 'rb') as f:
                  # Upload dengan nama asli
                  files = {'file': (original_name, f)}
                  response = requests.post(
                      'https://pixeldrain.com/api/file/',
                      auth=('', api_key),
                      files=files,
                      timeout=600
                  )
              
              if response.status_code == 201:
                  data = response.json()
                  file_id = data.get('id', '')
                  if file_id:
                      print(f"SUCCESS|{file_id}")
                  else:
                      print(f"ERROR|No ID in response: {response.text}")
                      sys.exit(1)
              else:
                  print(f"ERROR|Status {response.status_code}: {response.text}")
                  sys.exit(1)
          except Exception as e:
              print(f"ERROR|Exception: {str(e)}")
              sys.exit(1)
          EOFPYTHON
          
          RESULT=$(python3 /tmp/upload_script.py "$PK" "$FILE" "$FILENAME")
          
          if [[ "$RESULT" == SUCCESS* ]]; then
            ID="${RESULT#*|}"
            LINK="https://pixeldrain.com/u/$ID"
            echo "result_link=$LINK" >> $GITHUB_OUTPUT
            echo "service_name=PixelDrain" >> $GITHUB_OUTPUT
            echo "âœ… Upload berhasil: $LINK"
          else
            echo "âŒ Upload gagal: $RESULT"
            exit 1
          fi

      - name: Mock Upload to MediaFire
        id: upload_mediafire
        if: inputs.service == 'mediafire'
        run: |
          echo "Mocking MediaFire Upload..."
          echo "result_link=https://www.mediafire.com/file/dummy/file.zip" >> $GITHUB_OUTPUT
          echo "service_name=MediaFire" >> $GITHUB_OUTPUT

      - name: Mock Upload to GDrive
        id: upload_gdrive
        if: inputs.service == 'gdrive'
        run: |
          echo "Mocking GDrive Upload..."
          echo "result_link=https://drive.google.com/file/d/dummy123/view" >> $GITHUB_OUTPUT
          echo "service_name=Google Drive" >> $GITHUB_OUTPUT

      - name: Send Result to Telegram
        if: always()
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          CHAT_ID="${{ inputs.chat_id }}"
          MSG_ID="${{ inputs.message_id }}"
          
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${{ inputs.service }}" == "pixeldrain" ]; then
               LINK="${{ steps.upload_pixeldrain.outputs.result_link }}"
               SERVICE="${{ steps.upload_pixeldrain.outputs.service_name }}"
            elif [ "${{ inputs.service }}" == "mediafire" ]; then
               LINK="${{ steps.upload_mediafire.outputs.result_link }}"
               SERVICE="MediaFire"
            else
               LINK="${{ steps.upload_gdrive.outputs.result_link }}"
               SERVICE="Google Drive"
            fi
            
            MSG="âœ… *Upload Status*%0A%0A"
            MSG="${MSG}ğŸ“„ File: \`${{ inputs.filename }}\`%0A"
            MSG="${MSG}ğŸ“¦ Type: ${{ inputs.file_type }}%0A"
            MSG="${MSG}ğŸ’¾ Size: ${{ steps.download.outputs.file_size_mb }} MB%0A"
            MSG="${MSG}â˜ï¸ Service: $SERVICE%0A%0A"
            MSG="${MSG}ğŸ“Š *Current Status:* Complete!%0A"
            MSG="${MSG}â–°â–°â–°â–°â–°â–°â–°â–°â–°â–° 100%%%0A%0A"
            MSG="${MSG}ğŸ”— [Download Link]($LINK)"
          else
            MSG="âŒ *Upload Status*%0A%0A"
            MSG="${MSG}ğŸ“„ File: \`${{ inputs.filename }}\`%0A"
            MSG="${MSG}ğŸ“¦ Type: ${{ inputs.file_type }}%0A"
            MSG="${MSG}â˜ï¸ Service: ${{ inputs.service }}%0A%0A"
            MSG="${MSG}ğŸ“Š *Current Status:* Failed%0A"
            MSG="${MSG}Please try again or check logs."
          fi
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/editMessageText" \
            -d chat_id=$CHAT_ID \
            -d message_id=$MSG_ID \
            -d text="$MSG" \
            -d parse_mode="Markdown" \
            -d disable_web_page_preview=false
