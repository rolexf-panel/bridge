name: Auto Upload Bot Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL from Telegram'
        required: true
      service:
        description: 'Destination service'
        required: true
      chat_id:
        description: 'Telegram Chat ID'
        required: true
      telegram_token:
        description: 'Bot Token from VPS'
        required: true
      pixeldrain_key:
        description: 'PixelDrain Key from VPS'
        required: true

jobs:
  upload_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Sanitize & Download File
        id: download
        run: |
          RAW_URL="${{ inputs.file_url }}"
          echo "Raw URL: $RAW_URL"
          
          # Bersihkan URL ganda (jika ada)
          if [[ "$RAW_URL" == *"https://"*"https://"* ]]; then
             echo "Fixing Double URL..."
             CLEAN_URL=$(python3 -c "import sys; u=sys.argv[1]; print('https://' + u.split('https://')[-1])" "$RAW_URL")
          else
             CLEAN_URL="$RAW_URL"
          fi
          
          echo "Final URL: $CLEAN_URL"
          
          # Download file ke /tmp dengan retry mechanism
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -L --connect-timeout 30 --max-time 600 -o "/tmp/final_upload" "$CLEAN_URL"; then
              echo "Download berhasil!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Download gagal, retry $RETRY_COUNT dari $MAX_RETRIES..."
              sleep 2
            fi
          done
          
          if [ ! -f "/tmp/final_upload" ]; then
            echo "âŒ Download gagal setelah $MAX_RETRIES percobaan"
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z "/tmp/final_upload" 2>/dev/null || stat -c%s "/tmp/final_upload")
          echo "File size: $FILE_SIZE bytes"

      - name: Upload to PixelDrain
        id: upload_pixeldrain
        if: inputs.service == 'pixeldrain'
        run: |
          pip install requests > /dev/null 2>&1
          
          PK="${{ inputs.pixeldrain_key }}"
          # Hapus spasi/enter di akhir API Key
          PK=$(echo "$PK" | xargs)
          
          FILE="/tmp/final_upload"
          
          # Upload menggunakan Python untuk reliability yang lebih baik
          cat > /tmp/upload_script.py << 'EOFPYTHON'
          import requests
          import sys
          import json
          
          api_key = sys.argv[1]
          file_path = sys.argv[2]
          
          try:
              with open(file_path, 'rb') as f:
                  response = requests.post(
                      'https://pixeldrain.com/api/file/',
                      auth=('', api_key),
                      files={'file': f},
                      timeout=600
                  )
              
              if response.status_code == 201:
                  data = response.json()
                  file_id = data.get('id', '')
                  if file_id:
                      print(f"SUCCESS|{file_id}")
                  else:
                      print(f"ERROR|No ID in response: {response.text}")
                      sys.exit(1)
              else:
                  print(f"ERROR|Status {response.status_code}: {response.text}")
                  sys.exit(1)
          except Exception as e:
              print(f"ERROR|Exception: {str(e)}")
              sys.exit(1)
          EOFPYTHON
          
          # Jalankan script
          RESULT=$(python3 /tmp/upload_script.py "$PK" "$FILE")
          
          if [[ "$RESULT" == SUCCESS* ]]; then
            ID="${RESULT#*|}"
            LINK="https://pixeldrain.com/u/$ID"
            echo "result_link=$LINK" >> $GITHUB_OUTPUT
            echo "service_name=PixelDrain" >> $GITHUB_OUTPUT
            echo "âœ… Upload berhasil: $LINK"
          else
            echo "âŒ Upload gagal: $RESULT"
            exit 1
          fi

      - name: Mock Upload to MediaFire
        id: upload_mediafire
        if: inputs.service == 'mediafire'
        run: |
          echo "Mocking MediaFire Upload..."
          echo "result_link=https://www.mediafire.com/file/dummy/file.zip" >> $GITHUB_OUTPUT
          echo "service_name=MediaFire" >> $GITHUB_OUTPUT

      - name: Mock Upload to GDrive
        id: upload_gdrive
        if: inputs.service == 'gdrive'
        run: |
          echo "Mocking GDrive Upload..."
          echo "result_link=https://drive.google.com/file/d/dummy123/view" >> $GITHUB_OUTPUT
          echo "service_name=Google Drive" >> $GITHUB_OUTPUT

      - name: Send Result to Telegram
        if: always()
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          CHAT_ID="${{ inputs.chat_id }}"
          
          # Cek apakah upload berhasil
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${{ inputs.service }}" == "pixeldrain" ]; then
               LINK="${{ steps.upload_pixeldrain.outputs.result_link }}"
               SERVICE="${{ steps.upload_pixeldrain.outputs.service_name }}"
               MSG="âœ… Upload Berhasil ke $SERVICE%0A%0AğŸ”— Link: $LINK"
            elif [ "${{ inputs.service }}" == "mediafire" ]; then
               LINK="${{ steps.upload_mediafire.outputs.result_link }}"
               MSG="âœ… Mock Upload ke MediaFire%0A%0AğŸ”— Link: $LINK"
            else
               LINK="${{ steps.upload_gdrive.outputs.result_link }}"
               MSG="âœ… Mock Upload ke Google Drive%0A%0AğŸ”— Link: $LINK"
            fi
          else
            MSG="âŒ Upload gagal. Silakan coba lagi atau periksa logs di GitHub Actions."
          fi
          
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
            -d chat_id=$CHAT_ID \
            -d text="$MSG" \
            -d parse_mode="HTML"
