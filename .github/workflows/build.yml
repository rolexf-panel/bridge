name: Auto Upload Bot Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL from Telegram'
        required: true
      service:
        description: 'Destination service'
        required: true
      chat_id:
        description: 'Telegram Chat ID'
        required: true
      telegram_token:
        description: 'Bot Token from VPS'
        required: true
      pixeldrain_key:
        description: 'PixelDrain Key from VPS'
        required: true

jobs:
  upload_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Sanitize & Download File
        id: download
        run: |
          RAW_URL="${{ inputs.file_url }}"
          # Fix double URL
          if [[ "$RAW_URL" == *"https://"*"https://"* ]]; then
             CLEAN_URL=$(python3 -c "import sys; u=sys.argv[1]; print('https://' + u.split('https://')[-1])" "$RAW_URL")
          else
             CLEAN_URL="$RAW_URL"
          fi
          curl -L -o "/tmp/final_upload" "$CLEAN_URL"

      - name: Upload to PixelDrain (Multi-Method)
        id: upload_pixeldrain
        if: inputs.service == 'pixeldrain'
        run: |
          pip install requests > /dev/null
          PK="${{ inputs.pixeldrain_key }}"
          PK=$(echo "$PK" | xargs)
          FILE="/tmp/final_upload"
          SUCCESS="NO"
          
          # Method 1: Curl Raw
          RESP=$(curl -L -s -w "\nHTTP_STATUS:%{http_code}" -X POST -T "$FILE" -u ":$PK" "https://pixeldrain.com/api/file/")
          CODE=$(echo "$RESP" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
          if [ "$CODE" == "201" ]; then SUCCESS="YES"; BODY=$(echo "$RESP" | sed -e 's/HTTP_STATUS:[0-9]*$//'); fi

          # Method 2: Python Requests
          if [ "$SUCCESS" == "NO" ]; then
            RESP=$(python3 -c "import requests; r=requests.post('https://pixeldrain.com/api/file/', auth=('', '$PK'), files={'file': open('/tmp/final_upload', 'rb')}); print(r.text if r.status_code==201 else 'FAIL')" 2>&1)
            if [ "$RESP" != "FAIL" ]; then SUCCESS="YES"; BODY="$RESP"; fi
          fi
          
          if [ "$SUCCESS" == "YES" ]; then
             ID=$(echo "$BODY" | python3 -c "import sys, json; print(json.load(sys.stdin)['value']['id'])")
             LINK="https://pixeldrain.com/u/$ID"
             echo "result_link=$LINK" >> $GITHUB_OUTPUT
             echo "service_name=PixelDrain" >> $GITHUB_OUTPUT
          else
             echo "Upload Failed"; exit 1
          fi

      - name: Send Result to Telegram
        if: always()
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          LINK="${{ steps.upload_pixeldrain.outputs.result_link }}"
          MSG="Result: $LINK"
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d chat_id="${{ inputs.chat_id }}" -d text="$MSG"
