name: Auto Upload Bot Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL from Telegram (or external link)'
        required: true
      service:
        description: 'Destination service (pixeldrain, mediafire, gdrive)'
        required: true
      chat_id:
        description: 'Telegram Chat ID to send result to'
        required: true

jobs:
  upload_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Download File
        id: download
        run: |
          # Determine output file name
          EXT="${{ inputs.file_url }}"
          FILENAME="upload_file.${EXT##*.}"
          
          # Download file from URL
          curl -L -o "$FILENAME" "${{ inputs.file_url }}"
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT

      - name: Upload to PixelDrain
        id: upload_pixeldrain
        if: inputs.service == 'pixeldrain'
        run: |
          FILENAME="${{ steps.download.outputs.filename }}"
          
          # Upload to PixelDrain API
          RESPONSE=$(curl -s -F "file=@$FILENAME" https://pixeldrain.com/api/file/)
          
          # Parse JSON response using simple python
          LINK=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['link'])")
          echo "result_link=https://pixeldrain.com/u/$LINK" >> $GITHUB_OUTPUT
          echo "service_name=PixelDrain" >> $GITHUB_OUTPUT

      - name: Mock Upload to MediaFire (Example)
        id: upload_mediafire
        if: inputs.service == 'mediafire'
        run: |
          # Here you can add complex python or curl scripts for MediaFire API.
          # For this example, we return a dummy link.
          echo "result_link=https://www.mediafire.com/file/dummy/example/file.zip" >> $GITHUB_OUTPUT
          echo "service_name=MediaFire" >> $GITHUB_OUTPUT

      - name: Mock Upload to GDrive (Example)
        id: upload_gdrive
        if: inputs.service == 'gdrive'
        run: |
          # Here you need GDrive OAuth2 authentication (gdrive CLI or PyDrive)
          echo "result_link=https://drive.google.com/file/d/dummy123/view" >> $GITHUB_OUTPUT
          echo "service_name=Google Drive" >> $GITHUB_OUTPUT

      - name: Send Result to Telegram
        if: always()
        run: |
          TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
          CHAT_ID="${{ inputs.chat_id }}"
          
          # Determine message based on success/fail (simple example)
          if [ "${{ inputs.service }}" == "pixeldrain" ]; then
             LINK="${{ steps.upload_pixeldrain.outputs.result_link }}"
             MSG="✅ Upload Successful to ${{ steps.upload_pixeldrain.outputs.service_name }}%0A%0ALink: $LINK"
          elif [ "${{ inputs.service }}" == "mediafire" ]; then
             LINK="${{ steps.upload_mediafire.outputs.result_link }}"
             MSG="✅ Upload Successful to ${{ steps.upload_mediafire.outputs.service_name }}%0A%0ALink: $LINK"
          else
             LINK="${{ steps.upload_gdrive.outputs.result_link }}"
             MSG="✅ Upload Successful to ${{ steps.upload_gdrive.outputs.service_name }}%0A%0ALink: $LINK"
          fi
          
          # Send feedback message to user
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d chat_id=$CHAT_ID -d text="$MSG"
