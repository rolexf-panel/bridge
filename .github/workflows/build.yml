name: Auto Upload Bot Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL from Telegram'
        required: true
      service:
        description: 'Destination service (pixeldrain, mediafire, gdrive)'
        required: true
      chat_id:
        description: 'Telegram Chat ID'
        required: true
      telegram_token:
        description: 'Bot Token from VPS'
        required: true
      pixeldrain_key:
        description: 'PixelDrain Key from VPS'
        required: true

jobs:
  upload_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Download File
        id: download
        run: |
          echo "Starting download..."
          # Gunakan -L (follow redirects) dan -O (remote name) atau save as fixed name
          # Kita simpan sebagai 'target_file' untuk menghindari masalah ekstensi/nama panjang
          curl -L -o "target_file" "${{ inputs.file_url }}"
          
          echo "filename=target_file" >> $GITHUB_OUTPUT

      - name: Check File Size
        run: |
          echo "--- FILE INFO ---"
          ls -lh target_file
          echo "-----------------"

      - name: Upload to PixelDrain (API)
        id: upload_pixeldrain
        if: inputs.service == 'pixeldrain'
        run: |
          FILENAME="${{ steps.download.outputs.filename }}"
          
          echo "--- UPLOAD PROCESS ---"
          
          # ATTEMPT 1: Upload menggunakan API Key (Personal)
          echo "Trying Personal Upload (With API Key)..."
          RESPONSE=$(curl -L -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ inputs.pixeldrain_key }}" \
            -F "file=@$FILENAME" \
            "https://pixeldrain.com/api/file/")
            
          HTTP_STATUS=$(echo "$RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed -e 's/HTTP_STATUS:[0-9]*$//')
          
          echo "Personal Status Code: $HTTP_STATUS"
          
          # Jika Personal gagal (bukan 201), coba ATTEMPT 2: Upload Anonim
          if [ "$HTTP_STATUS" != "201" ]; then
            echo "Personal upload failed (Status $HTTP_STATUS). Trying Anonymous..."
            
            RESPONSE=$(curl -L -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
              -F "file=@$FILENAME" \
              "https://pixeldrain.com/api/file/")
              
            HTTP_STATUS=$(echo "$RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | sed -e 's/HTTP_STATUS:[0-9]*$//')
            
            echo "Anonymous Status Code: $HTTP_STATUS"
          fi
          
          # VALIDASI AKHIR
          if [ "$HTTP_STATUS" != "201" ]; then
            echo "❌ Upload Failed Completely."
            echo "Server Response Body:"
            echo "$BODY"
            exit 1
          fi
          
          # PARSING JSON UNTUK MENDAPATKAN ID
          # PixelDrain mengembalikan format: {"success": true, "value": {"id": "XYZ", ...}}
          ID=$(echo "$BODY" | python3 -c "import sys, json; print(json.load(sys.stdin)['value']['id'])")
          
          LINK="https://pixeldrain.com/u/$ID"
          echo "✅ Upload Success. ID: $ID"
          echo "-------------------------"
          
          echo "result_link=$LINK" >> $GITHUB_OUTPUT
          echo "service_name=PixelDrain" >> $GITHUB_OUTPUT

      - name: Mock Upload to MediaFire (Example)
        id: upload_mediafire
        if: inputs.service == 'mediafire'
        run: |
          echo "Mocking MediaFire Upload..."
          echo "result_link=https://www.mediafire.com/file/dummy/example/file.zip" >> $GITHUB_OUTPUT
          echo "service_name=MediaFire" >> $GITHUB_OUTPUT

      - name: Mock Upload to GDrive (Example)
        id: upload_gdrive
        if: inputs.service == 'gdrive'
        run: |
          echo "Mocking GDrive Upload..."
          echo "result_link=https://drive.google.com/file/d/dummy123/view" >> $GITHUB_OUTPUT
          echo "service_name=Google Drive" >> $GITHUB_OUTPUT

      - name: Send Result to Telegram
        if: always()
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          CHAT_ID="${{ inputs.chat_id }}"
          
          # Tentukan pesan berdasarkan hasil step upload
          if [ "${{ inputs.service }}" == "pixeldrain" ]; then
             LINK="${{ steps.upload_pixeldrain.outputs.result_link }}"
             if [ -z "$LINK" ]; then
                MSG="❌ Upload to PixelDrain Failed. Please check the logs."
             else
                MSG="✅ Upload Successful to PixelDrain%0A%0ALink: $LINK"
             fi
             
          elif [ "${{ inputs.service }}" == "mediafire" ]; then
             LINK="${{ steps.upload_mediafire.outputs.result_link }}"
             MSG="✅ Upload Successful to MediaFire%0A%0ALink: $LINK"
             
          elif [ "${{ inputs.service }}" == "gdrive" ]; then
             LINK="${{ steps.upload_gdrive.outputs.result_link }}"
             MSG="✅ Upload Successful to Google Drive%0A%0ALink: $LINK"
          else
             MSG="❌ Unknown service."
          fi
          
          # Kirim pesan
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d chat_id=$CHAT_ID -d text="$MSG"
