name: Auto Upload Bot Bridge

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL from Telegram'
        required: true
      service:
        description: 'Destination service'
        required: true
      chat_id:
        description: 'Telegram Chat ID'
        required: true
      telegram_token:
        description: 'Bot Token from VPS'
        required: true
      pixeldrain_key:
        description: 'PixelDrain Key from VPS'
        required: true

jobs:
  upload_and_notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Sanitize & Download File
        id: download
        run: |
          RAW_URL="${{ inputs.file_url }}"
          # Fix double URL
          if [[ "$RAW_URL" == *"https://"*"https://"* ]]; then
             CLEAN_URL=$(python3 -c "import sys; u=sys.argv[1]; print('https://' + u.split('https://')[-1])" "$RAW_URL")
          else
             CLEAN_URL="$RAW_URL"
          fi
          curl -L -o "/tmp/final_upload" "$CLEAN_URL"

      - name: Upload to PixelDrain (Robust Parsing)
        id: upload_pixeldrain
        if: inputs.service == 'pixeldrain'
        run: |
          pip install requests > /dev/null 2>&1
          PK="${{ inputs.pixeldrain_key }}"
          FILE="/tmp/final_upload"
          
          echo "Starting Upload to PixelDrain..."
          
          # --- ATTEMPT 1: PYTHON REQUESTS (Native) ---
          echo "[1/2] Trying Python Requests..."
          OUTPUT=$(python3 -c "
import requests, sys, json
try:
    with open('$FILE', 'rb') as f:
        # Upload file
        r = requests.post('https://pixeldrain.com/api/file/', auth=('', '$PK'), files={'file': f})
    
    if r.status_code == 201:
        # Kirim SUCCESS diikuti text JSON
        print('SUCCESS|' + r.text)
    else:
        # Kirim FAIL diikuti status code
        print(f'FAIL|Code {r.status_code}')
except Exception as e:
    print(f'FAIL|Exception {str(e)}')
" 2>&1)
          
          # Parsing output Python (Format: STATUS|BODY)
          STATUS=$(echo "$OUTPUT" | cut -d'|' -f1)
          BODY=$(echo "$OUTPUT" | cut -d'|' -f2-)
          
          # --- ATTEMPT 2: CURL (Jika Python gagal) ---
          if [ "$STATUS" != "SUCCESS" ]; then
             echo "[2/2] Python Failed ($STATUS). Trying Curl..."
             
             OUTPUT=$(curl -L -s -w "\nHTTP_CODE:%{http_code}" -X POST \
                -T "$FILE" \
                -u ":$PK" \
                "https://pixeldrain.com/api/file/")
             
             CODE=$(echo "$OUTPUT" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
             CURL_BODY=$(echo "$OUTPUT" | sed -e 's/HTTP_CODE:[0-9]*$//')
             
             if [ "$CODE" == "201" ]; then
                STATUS="SUCCESS"
                BODY="$CURL_BODY"
             fi
          fi
          
          # --- FINAL PARSING (Safe Mode) ---
          if [ "$STATUS" == "SUCCESS" ]; then
             echo "Server Response: $BODY"
             
             # Gunakan .get() agar tidak crash jika struktur JSON sedikit beda
             ID=$(echo "$BODY" | python3 -c "import sys, json; d=json.load(sys.stdin); print(d.get('value', {}).get('id', ''))" 2>&1)
             
             if [ -n "$ID" ]; then
                LINK="https://pixeldrain.com/u/$ID"
                echo "✅ Upload Success! Link: $LINK"
                echo "result_link=$LINK" >> $GITHUB_OUTPUT
                echo "service_name=PixelDrain" >> $GITHUB_OUTPUT
             else
                echo "❌ Error: Tidak bisa mengekstrak ID dari respons JSON."
                echo "Raw JSON: $BODY"
                exit 1
             fi
          else
             echo "❌ Upload Gagal Total. Status: $STATUS"
             exit 1
          fi

      - name: Send Result to Telegram
        if: always()
        run: |
          TOKEN="${{ inputs.telegram_token }}"
          LINK="${{ steps.upload_pixeldrain.outputs.result_link }}"
          MSG="Result: $LINK"
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d chat_id="${{ inputs.chat_id }}" -d text="$MSG"
